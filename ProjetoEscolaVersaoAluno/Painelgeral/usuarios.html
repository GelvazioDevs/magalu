<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Usuários</title>
  <link rel="stylesheet" href="usuarios.css">
</head>
<body>
  <div class="light-bg-anim"></div>
  <div class="luz-linha"></div>
  <div class="layout">
    <div id="sidebar"></div>
    <div class="content">
      <h1 class="usuarios-title">Alunos</h1>
      <div class="search-box">
        <select id="tipoBusca">
          <option value="nome">Nome</option>
          <option value="codigo">Código</option>
          <option value="email">Email</option>
          <option value="tipo">Tipo</option>
          <option value="turma">Turma</option>
          <option value="diretoria">Diretoria</option>
          <option value="materia">Matéria</option>
        </select>
        <select id="opcoesMateria" style="display:none;"></select>
        <input type="text" id="pesquisaUsuario" placeholder="Pesquisar...">
      </div>
      <button onclick="atualizarTabela()">Pesquisar-colocar css aqui....</button>
      <div class="usuarios-tabela-container">
        <table class="usuarios-tabela" id="tabelaUsuarios">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Código</th>
              <th>Email</th>
              <th>Tipo</th>
              <th>Turma</th>
              <th>Diretoria</th>
              <th>Matérias</th>
            </tr>
          </thead>
          <tbody>
            <!-- Conteúdo dinâmico -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="../Scripts/md5.js"></script>
  <script>
    fetch('sidebar.html').then(res => res.text()).then(data => {
      document.getElementById('sidebar').innerHTML = data;
      const usuario = JSON.parse(localStorage.getItem('usuarioLogado')) || { nome: 'Convidado', cargo: 'Convidado', email: '' };
      document.getElementById('sidebarUsuarioNome').textContent = usuario.nome || 'Convidado';
      document.getElementById('sidebarUsuarioCargo').textContent = usuario.cargo || 'Convidado';
      const avatar = document.getElementById('sidebarUsuarioAvatar');
      if (usuario.email) {
        const hash = md5(usuario.email.trim().toLowerCase());
        avatar.src = `https://www.gravatar.com/avatar/${hash}?d=identicon&s=80`;
      } else {
        avatar.src = '../Imagens/Usuario.png';
      }
      avatar.alt = usuario.nome || 'Convidado';
    });
    // Mock para simular a futura API
    async function buscarUsuarios() {
      // Aqui será: const res = await fetch('https://Api777999ATV/usuarios');
      // return await res.json();
      return await buscarDadosApi("usuarios");
    }
    function renderTabela(usuarios) {
      const tabela = document.getElementById('tabelaUsuarios');
      let thead = `<thead><tr><th>Nome</th><th>Código</th><th>Email</th><th>Tipo</th><th>Turma</th><th>Diretoria</th></tr></thead>`;
      let tbody = '<tbody>';
      
      usuarios.forEach(u => {
        tbody += `<tr><td>${u.nome}</td><td>${u.codigo}</td><td>${u.email}</td><td>${u.tipo}</td><td>${u.turma || ''}</td><td>${u.diretoria || ''}</td></tr>`;
      });

      tbody += '</tbody>';
      tabela.innerHTML = thead + tbody;
    }

    async function atualizarTabela() {
      const usuarios = await buscarUsuarios();
      const termo = document.getElementById('pesquisaUsuario').value.toLowerCase();
      const tipoBusca = document.getElementById('tipoBusca').value;
      let filtrados = usuarios;
      if (tipoBusca === 'diretoria') {
        filtrados = usuarios.filter(u => u.tipo === 'GESTOR');
      } else if (termo) {
        filtrados = usuarios.filter(u => {
          if (tipoBusca === 'nome') return u.nome.toLowerCase().includes(termo);
          if (tipoBusca === 'codigo') return u.codigo && u.codigo.toLowerCase().includes(termo);
          if (tipoBusca === 'email') return u.email && u.email.toLowerCase().includes(termo);
          if (tipoBusca === 'tipo') return u.tipo && u.tipo.toLowerCase().includes(termo);
          if (tipoBusca === 'turma') return u.turma && u.turma.toLowerCase().includes(termo);
          if (tipoBusca === 'materia' && u.materias) return u.materias.some(m => m.toLowerCase().includes(termo));
          return false;
        });
      }
      renderTabela(filtrados);
    }

    document.getElementById('pesquisaUsuario').addEventListener('input', atualizarTabela);
    document.getElementById('tipoBusca').addEventListener('change', atualizarTabela);

  </script>

  <script src="../Scripts/usuarios.js"></script> 
  <script src="../Scripts/api.js"></script> 
</body>
</html>